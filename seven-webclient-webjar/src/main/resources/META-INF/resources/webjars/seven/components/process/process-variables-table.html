<div v-if="selectedInstance" class="h-100">					
	<b-button variant="light" style="min-height: 40px; line-height: 20px;" :block="true" class="rounded-0 border-bottom text-start" @click="$emit('clear-state'); $emit('unselect-instance')">
   		<span class="mdi mdi-18px mdi-arrow-left me-2 float-start"></span>
   		<h5 class="m-0">
   			{{ $t('process-instance.processInstanceId') }}: {{ selectedInstance.id }} 
   			<span v-if="selectedInstance.businessKey"> | {{ $t('process-instance.businessKey') }}: {{ selectedInstance.businessKey }}</span>
   		</h5>
   	</b-button>
   	<div @mousedown="handleMouseDown" class="v-resizable position-absolute w-100" style="left: 0" :style="'height: ' + bpmnViewerHeight + 'px; ' + toggleTransition">
		<bpmn-viewer @child-activity="filterByChildActivity($event)" @task-selected="selectTask($event)" :activityId="activityId" :activity-instance="activityInstance" :activity-instance-history="activityInstanceHistory" :statistics="process.statistics" 
		@open-subprocess="$emit('open-subprocess', $event)" :process-definition-id="process.id" ref="diagram" class="h-100" :activities-history="process.activitiesHistory"></bpmn-viewer>
	</div>
	
	<ul class="nav nav-tabs position-absolute border-0 bg-light" style="left: -1px" :style="'top: ' + (bottomContentPosition - toggleButtonHeight) + 'px; ' + toggleTransition">
		<span role="button" size="sm" variant="light" class="border-bottom-0 bg-white rounded-top border py-1 px-2 me-1" @click="toggleContent">
			<span class="mdi mdi-18px" :class="toggleIcon"></span>
		</span>
		<li class="nav-item m-0" v-for="tab in tabs">
			<a role="button" @click="changeTab(tab)" class="nav-link py-2" :class="{ 'active': tab.active, 'bg-light border border-bottom-0': !tab.active }">
				{{ $t('process.' + tab.id) }}
			</a> 
	  	</li>
	</ul>
	
	<div ref="rContent" class="position-absolute w-100" style="bottom: 0" :style="'top: ' + bottomContentPosition + 'px; ' + toggleTransition">
		<div v-if="activeTab === 'variables'">
			<div v-if="selectedInstance.state === 'ACTIVE'" class="bg-light d-flex position-absolute w-100">
				 <div class="py-2 px-2">
					<b-button class="border" size="sm" variant="light" @click="$refs.addVariableModal.show()" :title="$t('process-instance.addVariable')">
						<span class="mdi mdi-plus"></span> {{ $t('process-instance.addVariable') }}
					</b-button>
				 </div>
			</div>
			<div class="overflow-auto bg-white position-absolute container-fluid" style="bottom: 0" :style="('top: ' + (selectedInstance.state === 'ACTIVE' ? '45px' : '0'))">
				<flow-table v-if="filteredVariables" striped resizable thead-class="sticky-header" :items="filteredVariables" primary-key="id" prefix="process-instance.variables."
					sort-by="label" :sort-desc="true" :fields="[
					{ label: 'name', key: 'name', class: 'col-3', tdClass: 'py-1 border-end border-top-0' },
					{ label: 'type', key: 'type', class: 'col-2', tdClass: 'py-1 border-end border-top-0' },
					{ label: 'value', key: 'value', class: 'col-4', tdClass: 'py-1 border-end border-top-0' },
					{ label: 'scope', key: 'scope', class: 'col-2', tdClass: 'py-1 border-end border-top-0' },
					{ label: 'actions', key: 'actions', class: 'col-1', sortable: false, tdClass: 'py-1 border-top-0' }]">
					<template v-slot:cell(name)="table">
						<div :title="table.item.name" class="text-truncate">{{ table.item.name }}</div>
					</template>
					<template v-slot:cell(type)="table">
						<div :title="table.item.type" class="text-truncate">{{ table.item.type }}</div>
					</template>
					<template v-slot:cell(value)="table">
						<div v-if="table.item.type === 'File'" class="text-truncate">{{ table.item.valueInfo.filename }}</div>
						<div v-if="isFileValueDataSource(table.item)" class="text-truncate">
							{{ displayObjectNameValue(table.item) }}
						</div>
						<div v-else :title="table.item.value" class="text-truncate">{{ table.item.value }}</div>
					</template>
					<template v-slot:cell(actions)="table">
						<b-button v-if="isFile(table.item)" :title="$t('process-instance.download')" 
							size="sm" variant="outline-secondary" class="border-0 mdi mdi-18px mdi-download-outline" 
							@click="downloadFile(table.item)">
						</b-button>
						<b-button v-if="isFile(table.item)" :title="$t('process-instance.upload')" 
							size="sm" variant="outline-secondary" class="border-0 mdi mdi-18px mdi-upload-outline"
							@click="selectedVariable = table.item; $refs.uploadFile.show()">
						</b-button>
						<b-button v-if="!['File', 'Null'].includes(table.item.type) && !isFileValueDataSource(table.item)" 
							:title="$t('process-instance.edit')" size="sm" variant="outline-secondary" class="border-0 mdi mdi-18px mdi-square-edit-outline" 
							@click="modifyVariable(table.item)">
						</b-button>
						<b-button v-if="selectedInstance.state !== 'SUSPENDED'" :title="$t('process-instance.edit')" size="sm" variant="outline-secondary" 
							class="border-0 mdi mdi-18px mdi-delete-outline" @click="$refs.deleteVariable.show(table.item)"></b-button>
					</template>
				</flow-table>
			</div>
		</div>
		<div v-if="activeTab === 'incidents'">
			<div class="overflow-auto bg-white position-absolute container-fluid" style="top: 0; bottom: 0">
				<flow-table v-if="selectedInstance.incidents.length > 0" striped thead-class="sticky-header" :items="selectedInstance.incidents" primary-key="id" prefix="process-instance.incidents."
					sort-by="label" :sort-desc="true" :fields="[
					{ label: 'message', key: 'incidentMessage', class: 'col-3', tdClass: 'py-1 border-end border-top-0' },
					{ label: 'timestamp', key: 'incidentTimestamp', class: 'col-2', tdClass: 'py-1 border-end border-top-0' },
					{ label: 'activity', key: 'activityId', class: 'col-2', tdClass: 'py-1 border-end border-top-0' },
					{ label: 'failedActivity', key: 'failedActivityId', class: 'col-2', tdClass: 'py-1 border-end border-top-0' },
					{ label: 'incidentType', key: 'incidentType', class: 'col-2', tdClass: 'py-1 border-top-0' },
					{ label: 'actions', key: 'actions', class: 'col-1', sortable: false, tdClass: 'py-1 border-top-0' }]">
					<template v-slot:cell(incidentMessage)="table">
						<div :title="table.item.incidentMessage" class="text-truncate" @click="showIncidentMessage(table.item.configuration)">{{ table.item.incidentMessage }}</div>
					</template>
					<template v-slot:cell(incidentTimestamp)="table">
						<div :title="table.item.incidentTimestamp" class="text-truncate">{{ showPrettyTimestamp(table.item.incidentTimestamp) }}</div>
					</template>
					<template v-slot:cell(activityId)="table">
						<div :title="table.item.activityId" class="text-truncate">{{ getActivityName(table.item.activityId) }}</div>
					</template>
					<template v-slot:cell(failedActivityId)="table">
						<div :title="table.item.failedActivityId" class="text-truncate">{{ getFailingActivity(table.item.failedActivityId) }}</div>
					</template>
					<template v-slot:cell(incidentType)="table">
						<div :title="table.item.incidentType" class="text-truncate">{{ table.item.incidentType }}</div>
					</template>
					<template v-slot:cell(actions)="table">
						<b-button :title="$t('process-instance.incidents.retryJob')" 
							size="sm" variant="outline-secondary" class="border-0 mdi mdi-18px mdi-reload" 
							@click="$refs.confirmRetryJob.show(table.item.configuration)">
						</b-button>
					</template>
				</flow-table>
				<div v-else>
					<p class="text-center p-4">{{ $t('process-instance.noIncidents') }}</p>
				</div>
			</div>
		</div>
		<div v-if="activeTab === 'usertasks'">
			<user-tasks-table :selectedInstance="selectedInstance"></user-tasks-table>
		</div>
	</div>
 
	<task-popper ref="importPopper"></task-popper>
	<b-modal ref="uploadFile" :title="$t('process-instance.upload')">
		<div class="container-fluid">
			<b-form-file placeholder="" :browse-text="$t('process-instance.selectFile')" v-model="file"></b-form-file>
		</div>
		<template v-slot:modal-footer>
			<b-button v-t="'confirm.cancel'" @click="$refs.uploadFile.hide(); file = null"></b-button>
			<b-button :disabled="!file" v-t="'process-instance.upload'" variant="primary" @click="uploadFile(); $refs.uploadFile.hide()"></b-button>
		</template>
	</b-modal>
	<b-modal ref="modifyVariable" :title="$t('process-instance.edit')">
		<div v-if="variableToModify" class="container-fluid">
			<b-form-group :label="$t('process-instance.variables.name')">
    			<b-form-input v-model="variableToModify.name" disabled></b-form-input>
    		</b-form-group>
			<b-form-group :label="$t('process-instance.variables.type')">
    			<b-form-input v-model="variableToModify.type" disabled></b-form-input>
    		</b-form-group>
			<b-form-group :label="$t('process-instance.variables.value')">
				<b-form-textarea rows="5" placeholder="Enter value" v-model="formattedJsonValue" :disabled="selectedInstance.state === 'COMPLETED'"></b-form-textarea>
			</b-form-group>
		</div>
		<template v-slot:modal-footer>
			<b-button v-if="selectedInstance.state === 'COMPLETED'" v-t="'confirm.close'" @click="$refs.modifyVariable.hide()"></b-button>
			<template v-else>
				<b-button v-t="'confirm.cancel'" @click="$refs.modifyVariable.hide()"></b-button>
				<b-button v-t="'process-instance.save'" variant="primary" @click="updateVariable"></b-button>
			</template>
		</template>
	</b-modal>
	<b-modal ref="stackTraceModal" :title="$t('process-instance.stacktrace')" size="xl">
		<div v-if="stackTraceMessage" class="container-fluid pt-3">
			<b-form-textarea v-model="stackTraceMessage" rows="20" readonly></b-form-textarea>
			<b-button variant="link" @click="copyValueToClipboard(stackTraceMessage)">{{ $t('process-instance.copyValueToClipboard') }}</b-button>
		</div>
		<template v-slot:modal-footer>
			<b-button v-t="'confirm.close'" @click="$refs.stackTraceModal.hide()"></b-button>
		</template>
	</b-modal>
	<success ref="messageCopy" style="z-index: 9999">{{ $t('process.copySuccess') }}</success>
	<confirm ref="confirmRetryJob" @ok="retryJob($event)">
		{{ $t('process-instance.confirmRetryJob') }}
	</confirm>
	<add-variable-modal ref="addVariableModal" :selected-instance="selectedInstance" @variable-added="loadSelectedInstanceVariables(); $refs.success.show()"></add-variable-modal>
	<success ref="successRetryJob">{{ $t('process-instance.successRetryJob') }}</success>
	<confirm ref="deleteVariable" @ok="deleteVariable($event)">
		{{ $t('confirm.performOperation') }}
	</confirm>
	<success top="0" style="z-index: 1031" ref="success">{{ $t('alert.successOperation') }}</success>
</div>
