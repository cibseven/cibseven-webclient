<div class="d-flex flex-column bg-light" :style="{ height: 'calc(100% - 55px)' }">
	<div class="container-fluid pb-2 pt-4">
		<div class="row align-items-center px-4">		
			<div class="col-4">  				
			 	<b-input-group size="sm">
				    <template #prepend>
			      		<b-button class="rounded-left" variant="secondary"><span class="mdi mdi-magnify" style="line-height: initial"></span></b-button>
				    </template>
				    <b-form-input :placeholder="$t('searches.search')" @keyup="searchAuthorizations" v-model="filter"></b-form-input>
  				</b-input-group>
			 </div>
			 <div class="col-8 text-end">
			 	<b-button class="border me-1" size="sm" variant="light" @click="add()">
			 		<span class="mdi mdi-plus"> {{ $t('admin.authorizations.add') }} </span>
		 		</b-button>
		 		<b-button v-if="$root.config.userProvider === 'de.cib.cibflow.auth.CamundaUserProvider' && exportableAuth" class="border" size="sm" variant="light" 
					:disabled="exporting" @click="exportCSV()">
					<span v-if="exporting"><b-spinner small></b-spinner> {{ $t('admin.exportCsv') }}</span>
					<span v-else class="mdi mdi-download"> {{ $t('admin.exportCsv') }} </span>
				</b-button>
			 </div>
	 	</div>
	</div>
	<div class="container-fluid overflow-auto h-100 g-0" @scroll="showMore">		
	 	<div class="px-4 mb-5">			
			<flow-table striped thead-class="sticky-header light" :items="authorizations" primary-key="id"
			 	prefix="admin.authorizations." :fields="authorizationFields"
				@contextmenu="focused = $event" @mouseenter="focused = $event" @mouseleave="focused = null">
				<template v-slot:cell(type)="row">
					<div class="w-100 d-flex align-items-center" v-if="edit === row.item.id && edit === '0'">
						<span> {{ $t('admin.authorizations.types.' + types[row.item.type].key) }} </span>
						<b-dropdown class="float-right" size="lg" variant="link" toggle-class="text-decoration-none" no-caret>
							<template #button-content>
								<b-button class="border-0" variant="outline-secondary">
									<span class="mdi mdi-18px mdi-pencil"></span>
								</b-button>
							</template>
							<b-dropdown-item class="ms-2" v-for="type in types" :key="type.key"
								@click="row.item.type = type.id" :active="row.item.type === type.id">
								{{ $t('admin.authorizations.types.' + type.key) }}
							</b-dropdown-item>
						</b-dropdown>
					</div>
					<div v-else>
						<span> {{ $t('admin.authorizations.types.' + types[row.item.type].key) }} </span>
					</div>
                   </template>
				<template v-slot:cell(userIdGroupId)="row">
					<div v-if="edit === row.item.id">
						<b-input-group>
							<b-input-group-prepend>
								<b-button variant="outline-secondary" @click="isUserToEdit = !isUserToEdit">
									<span class="mdi" :class="isUserToEdit ? 'mdi-account' : 'mdi-account-group'"></span>
								</b-button>
							</b-input-group-prepend>
							<b-form-input v-if="row.item.userId" v-model="row.item.userId" autofocus></b-form-input>
							<b-form-input v-else v-model="row.item.groupId" autofocus></b-form-input>								
						</b-input-group>
					</div>
					<div v-else>
                        <span class="mdi" :class="row.item.userId ? 'mdi-account' : 'mdi-account-group'"></span>
                        {{ row.item.userId != null ? row.item.userId : row.item.groupId }} 
					</div>
                   </template>
				<template v-slot:cell(permissions)="row">
					<div class="w-100 d-flex align-items-center" v-if="edit === row.item.id">
						<span v-if="selected.length === resourcesTypes[$route.params.resourceTypeId].permissions.length">
							ALL
						</span>
						<span v-else-if="selected.length === 0">
							NONE
						</span>
						<span v-else>{{ selected.join(", ") }}</span>
						<b-dropdown class="float-right" size="lg" variant="link" toggle-class="text-decoration-none" no-caret>
							<template #button-content>
								<b-button class="border-0" variant="outline-secondary"><span class="mdi mdi-18px mdi-pencil"></span></b-button>
							</template>
							<b-form-checkbox class="ms-2" @input="selectAll(row.item)"> 
								<span v-if="selected.length === resourcesTypes[$route.params.resourceTypeId].permissions.length">
									{{ $t('admin.authorizations.unselectAll') }}
								</span>
								<span v-else>
									{{ $t('admin.authorizations.selectAll') }}
								</span>
							</b-form-checkbox>
							<b-dropdown-divider></b-dropdown-divider>
							<b-form-checkbox class="ms-2" v-for="permission in resourcesTypes[$route.params.resourceTypeId].permissions"
								:value="permission" :key="permission" v-model="selected"> 
								{{ permission }}
							</b-form-checkbox>						
						</b-dropdown>
					</div>
					<div v-else>
						<span v-if="row.item.permissions.length > 0">{{ row.item.permissions.join(", ") }}</span>
						<span v-if="row.item.permissions.length === 0">NONE</span>
					</div>
				</template>        
                <template v-slot:cell(name)="row">
                	<div v-if="edit === row.item.id">
                		<b-form-select v-model="row.item.name" :options="filterNameOptions" @change="onFilterNameChange(row.item)">
                			<template v-slot:first>
								<b-form-select-option :value="null"></b-form-select-option>
							</template>
                		</b-form-select>
                	</div>
                	<div v-else> {{ row.item.name }} </div>
                </template>
				<template v-slot:cell(resourceId)="row">
					<div v-if="edit === row.item.id">
						<b-form-input v-model="row.item.resourceId" :readonly="!!row.item.name"></b-form-input>
					</div>
					<div v-else> {{ row.item.resourceId }} </div>
                </template>   
				<template v-slot:cell(actions)="row">
					<div class="d-flex">
	    				<div v-if="edit === row.item.id">
	    					<b-button style="opacity: 1" class="px-2 border-0 shadow-none" variant="link" @click="save(row.item)" 
	    						:disabled="focused !== row.item || (row.item.userId == null && row.item.groupId == null)"><span class="mdi mdi-18px mdi-content-save-outline"></span></b-button>		    						
							<span class="border-start h-50" :class="focused === row.item ? 'border-secondary' : ''"></span>
	    					<b-button :disabled="focused !== row.item" style="opacity: 1" class="px-2 border-0 shadow-none" variant="link" @click="cancelEdit(row.item)"><span class="mdi mdi-18px mdi-block-helper"></span></b-button>
	    				</div>
	    				<div v-else>
	    					<b-button :disabled="focused !== row.item" style="opacity: 1" variant="link" class="px-2 border-0 shadow-none" @click="prepareEdit(row.item)"><span class="mdi mdi-18px mdi-pencil-outline"></span></b-button>
	    					<span class="border-start h-50" :class="focused === row.item ? 'border-secondary' : ''"></span>
	    					<b-button :disabled="focused !== row.item" style="opacity: 1" variant="link" class="px-2 border-0 shadow-none" @click="prepareRemove(row.item)"><span class="mdi mdi-18px mdi-delete-outline"></span></b-button>
	    				</div>
    				</div>
                   </template>
			</flow-table>
			<div class="text-center w-100" v-if="loading">
				<loader class="d-inline me-2" styling="width: 35px"></loader> {{ $t('admin.loading') }}
			</div>
			<div class="text-center w-100" v-if="!loading && authorizations.length === 0">
				{{ $t('admin.noResults') }}
			</div>
	 	</div>
	</div>
	
	<b-modal ref="deleteModal" :title="$t('confirm.title')">
		<div class="container-fluid">
			<div class="row align-items-center">
				<div class="col-2">
					<span class="mdi-36px mdi mdi-alert-outline text-warning me-3"></span>
				</div>	
				<div class="col-10">
					<span v-if="authorizationSelected" 
						v-html="$t('admin.authorizations.confirmDelete',
						 [$t('admin.authorizations.types.' + types[authorizationSelected.type].key),
						 authorizationSelected.userId, 
						 authorizationSelected.groupId, 
						 authorizationSelected.permissions.join(', '), 
						 $t('admin.authorizations.resourcesTypes.' + resourcesTypes[$route.params.resourceTypeId].key),
						 authorizationSelected.resourceId,])"></span>
				</div>			
			</div>
		</div>
		<template v-slot:modal-footer>
			<b-button v-t="'confirm.ok'" variant="primary" 
				@click="remove(authorizationSelected); $refs.deleteModal.hide()"></b-button>
			<b-button v-t="'confirm.cancel'" @click="$refs.deleteModal.hide()"></b-button>
		</template>
	</b-modal>
	<task-popper ref="importPopper"></task-popper>
</div>